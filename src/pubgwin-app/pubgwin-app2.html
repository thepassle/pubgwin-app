<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/paper-spinner/paper-spinner.html">

<script src="../../node_modules/axios/dist/axios.min.js"></script>


<dom-module id="pubgwin-app2">
  <template>
    <style>
    :host {
      display: block;
      height: 100vh;
      width: 100vw;
      background-color: rgb(0,255,0);
    }
  </style>
  <h3>player name(route): {{playerName}}</h3>

  <template is="dom-if" if=[[!playerError.status]]>
    <template is="dom-if" if=[[!loading]]>
      <h3>api player response: [[res]]</h3>
    </template>

    <template is="dom-if" if=[[loading]]>
      <paper-spinner active></paper-spinner>
    </template>


    <template is="dom-if" if=[[!loadingRank]]>
      <h3>Amount of wins: [[wins]]</h3>
    </template>

    <template is="dom-if" if=[[loadingRank]]>
      <paper-spinner active></paper-spinner>
    </template>
  </template>

  <template is="dom-if" if=[[playerError.status]]>
    [[playerError.message]]
  </template>

</template>

<script>

  class PubgwinApp2 extends Polymer.Element {
    static get is() { return 'pubgwin-app2'; }
    static get properties() {
      return {
        res: {
          type: String
        },

        loading: {
          type: Boolean,
          value: true
        },
        loadingRank: {
          type: Boolean,
          value: true
        },
        oldMatchId: {
          type: String,
          value: ""
        },
        wins: {
          type: Number,
          value: 0
        },
        initialized: {
          type: Boolean,
          value: false,
        },

        playerError: {
          type: Object,
          value: () => {
            return {
              "status": false,
              "message": "",
            }
          }
        }

      };
    }

    ready() {
      super.ready();

      this.getData();
      setInterval(() => {
        this.getData();
      }, 10000);
      
    };

    getData(){
      const headers = {
        headers: {
          'Authorization': `Bearer ${this.apiKey}`,
          'Accept': 'application/vnd.api+json',
          'Content-Type': 'application/json'
        } 
      }

      axios.get(`https://api.playbattlegrounds.com/shards/${this.region}/players?filter[playerNames]=${this.playerName}`, headers).then( (res) => { 
        let newestMatchId = res.data.data[0].relationships.matches.data[0].id;
        this.set('playerError.status', false);

        if(newestMatchId !== this.oldMatchId){
          this.oldMatchId = newestMatchId;
          
          this.res = res.data.data[0].attributes.name + " " + res.data.data[0].id;
          this.loading = false;

          axios.get(`https://api.playbattlegrounds.com/shards/${this.region}/matches/${newestMatchId}`, headers).then( (res) => {
            let player = res.data.included.filter( (item) => {
              return item.type === 'participant' && item.attributes.stats.name === this.playerName;
            })[0];

            let lastRank = player.attributes.stats.winPlace;

            if(this.initialized){
              if(lastRank === 1){
                this.wins += 1;                  
              }
            } 

            this.loadingRank = false;

            if(!this.initialized){
              this.initialized = true;
            }

            console.log("Success");
          });
        } else {
          console.log('no new match');
        }
      }).catch((err) => {
        console.log(err.response);
        console.log(err.response.status);

        this.set('playerError.status', true);

        if(err.response.status === 401){
          this.set('playerError.message', 'Invalid API key!');
        } else {
          this.set('playerError.message', err.response.data.errors[0].detail);
        }

        this.loading = false;
        this.loadingRank = false;
      });
    }

  }

  window.customElements.define(PubgwinApp2.is, PubgwinApp2);
</script>
</dom-module>
