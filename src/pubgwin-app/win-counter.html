<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/paper-spinner/paper-spinner.html">
<link rel="import" href="../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../bower_components/paper-tooltip/paper-tooltip.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">

<link href="https://fonts.googleapis.com/css?family=Roboto:700" rel="stylesheet">

<script src="../../node_modules/axios/dist/axios.min.js"></script>

<dom-module id="win-counter">
  <template>
    <style>
    :host {
      font-family: 'Roboto';
      --icon-size: 60px; 

      display: block;
      height: 100vh;
      width: 100vw;
      background-color: rgb(0,255,0);
    }

    .wrapper{
      display: flex;
      height: 100%;
      flex-direction: column;
    }

    .title{
      font-size: 9vw;
      text-align: left;
      vertical-align: center;
      flex: 1;
      flex-grow: 1;
      display: flex;
      justify-content: center;
      align-items: center;

      color: #fff;
      text-shadow:0px 4px 15px #000000;
    }

    .title h1{
      margin-left: 25px;
    }

    paper-spinner {
      font-size: 0px;
    }

    paper-dialog {
      width: calc(100% - 20px);
      max-width: 600px;
      height: auto;
      word-wrap: break-word;
    }

    .error {
      font-size: 3vw;
    }

    #copy {
      cursor: copy;
    }

    .ok-icon{
      --iron-icon-height: var(--icon-size);
      --iron-icon-width: var(--icon-size);
    }

    .nok-icon{
      --iron-icon-height: var(--icon-size);
      --iron-icon-width: var(--icon-size);
      --iron-icon-fill-color: rgb(255,0,0);
    }
    
  </style>

  <div class="wrapper">

    <div class="title">
      <template is="dom-if" if=[[loading]]>
        <paper-spinner active></paper-spinner>
      </template>

      <template is="dom-if" if=[[!loading]]>
        <template is="dom-if" if=[[!playerError.status]]>
          <iron-icon class="ok-icon" icon="icons:check-circle"></iron-icon>
        </template>
      </template>

      <template is="dom-if" if=[[playerError.status]]>
        <iron-icon class="nok-icon" icon="icons:cancel"></iron-icon>
      </template>
      <h1>
        WINS:
      </h1>

      <template is="dom-if" if=[[!playerError.status]]>
        <template is="dom-if" if=[[!loadingRank]]>
          <h1>[[wins]]</h1>
        </template>

        <template is="dom-if" if=[[loadingRank]]>
          <paper-spinner active></paper-spinner>
        </template>
      </template>

      <template is="dom-if" if=[[playerError.status]]>
        <template is="dom-if" if=[[!loadingRank]]>
          <h1 class="error">[[playerError.message]]</h1>
        </template>

        <template is="dom-if" if=[[loadingRank]]>
          <paper-spinner active></paper-spinner>
        </template>
      </template>
    </div>

  </div>
</template>

<script>

// to do: API to keep track of users

class WinCounter extends Polymer.Element {
  static get is() { return 'win-counter'; }
  static get properties() {
    return {
      loading: {
        type: Boolean,
        value: true
      },
      loadingRank: {
        type: Boolean,
        value: true
      },
      oldMatchId: {
        type: String,
        value: ""
      },
      wins: {
        type: Number,
        value: 0
      },
      initialized: {
        type: Boolean,
        value: false,
      },

      playerError: {
        type: Object,
        value: () => {
          return {
            "status": false,
            "message": "",
          }
        }
      }

    };
  }

  toUpper(name) {
    return name.toUpperCase();
  }

  ready() {
    super.ready();

    this.getData();

    setInterval(() => {
      this.getData();
    }, 20000);

  };

  getData(){
    const headers = {
      headers: {
        'Authorization': `Bearer ${this.apiKey}`,
        'Accept': 'application/vnd.api+json',
        'Content-Type': 'application/json'
      } 
    }

    axios.get(`https://api.playbattlegrounds.com/shards/${this.region}/players?filter[playerNames]=${this.playerName}`, headers).then( (res) => { 
        // console.log(res);
        // console.log("getting player");
        console.log(res.data);
        let newestMatchId = res.data.data[0].relationships.matches.data[0].id;
        this.set('playerError.status', false);
        console.log(res.data.data[0].relationships.matches);
        console.log(newestMatchId);
        console.log(this.oldMatchId);

        if(newestMatchId !== this.oldMatchId){
          console.log("NEW MATCH:");
          this.loading = false;

          axios.get(`https://api.playbattlegrounds.com/shards/${this.region}/matches/${newestMatchId}`, headers).then( (res) => {
            let player = res.data.included.filter( (item) => {
              return item.type === 'participant' && item.attributes.stats.name === this.playerName;
            })[0];

            let lastRank = player.attributes.stats.winPlace;

            if(this.initialized){
              if(lastRank === 1){
                console.log("Win!");
                this.wins += 1;                  
              }
            } 

            console.log("No win :(");
            this.loadingRank = false;

            if(!this.initialized){
              this.initialized = true;
            }

            // this.$.modal.open();
            // setTimeout(()=>{
            //   this.$.modal.close();
            // }, 5000);
            console.log("");
            // console.log("Success");
            this.oldMatchId = newestMatchId;
          });
        } else {
          // console.log('no new match');
        }
      }).catch((err) => {
        // console.log(err.response);
        // console.log(err.response.status);

        this.set('playerError.status', true);

        if(err.response.status === 401){
          this.set('playerError.message', 'Invalid API key!');
        } else if (err.response.status === 429){
          this.set('playerError.message', 'Too many requests!');
        } else {
          this.set('playerError.message', err.response.data.errors[0].detail);
        }

        this.loading = false;
        this.loadingRank = false;
      });

    }

  }

  window.customElements.define(WinCounter.is, WinCounter);
</script>
</dom-module>
