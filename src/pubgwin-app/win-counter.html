<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/paper-spinner/paper-spinner.html">
<link rel="import" href="../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../bower_components/paper-tooltip/paper-tooltip.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">

<link href="https://fonts.googleapis.com/css?family=Source+Code+Pro:700" rel="stylesheet">

<script src="../../node_modules/axios/dist/axios.min.js"></script>


<dom-module id="win-counter">
  <template>
    <style>
    :host {
      font-family: 'Source Code Pro';
      --icon-size: 32px; 

      display: block;
      height: 100vh;
      width: 100vw;
      background-color: rgb(0,255,0);
    }

    .wrapper{
      display: flex;
      height: 100%;
      flex-direction: column;
    }

    .title{
      font-size: 3vw;
      text-align: center;
      vertical-align: center;
      flex: 1;
      flex-grow: 1;
      display: flex;
      justify-content: center;
      align-items: center;

      color: #fff;
      text-shadow: #ccc 0 1px 0, #c9c9c9 0 2px 0, #bbb 0 3px 0, #b9b9b9 0 4px 0, #aaa 0 5px 0,rgba(0,0,0,.1) 0 6px 1px, rgba(0,0,0,.1) 0 0 5px, rgba(0,0,0,.3) 0 1px 3px, rgba(0,0,0,.15) 0 3px 5px, rgba(0,0,0,.2) 0 5px 10px, rgba(0,0,0,.2) 0 10px 10px, rgba(0,0,0,.1) 0 20px 20px;
    }

    .title h1{
      margin-left: 25px;
    }

    .count{
      font-size: 40vw;
      text-align: center;
      vertical-align: center;
      flex: 1;
      flex-grow: 5;
      display: flex;
      justify-content: center;
      align-items: center;

      color: #fff;
      text-shadow: #ccc 0 1px 0, #c9c9c9 0 2px 0, #bbb 0 3px 0, #b9b9b9 0 4px 0, #aaa 0 5px 0,rgba(0,0,0,.1) 0 6px 1px, rgba(0,0,0,.1) 0 0 5px, rgba(0,0,0,.3) 0 1px 3px, rgba(0,0,0,.15) 0 3px 5px, rgba(0,0,0,.2) 0 5px 10px, rgba(0,0,0,.2) 0 10px 10px, rgba(0,0,0,.1) 0 20px 20px;    
    }

    .error{
      font-size: 4vw;
      text-align: center;
      vertical-align: center;
      flex: 1;
      flex-grow: 5;
      border-left: var(--border-size) solid white;
      border-right: var(--border-size) solid white;
      border-bottom: var(--border-size) solid white;
      display: flex;
      justify-content: center;
      align-items: center;

      color: #fff;
      text-shadow: #ccc 0 1px 0, #c9c9c9 0 2px 0, #bbb 0 3px 0, #b9b9b9 0 4px 0, #aaa 0 5px 0,rgba(0,0,0,.1) 0 6px 1px, rgba(0,0,0,.1) 0 0 5px, rgba(0,0,0,.3) 0 1px 3px, rgba(0,0,0,.15) 0 3px 5px, rgba(0,0,0,.2) 0 5px 10px, rgba(0,0,0,.2) 0 10px 10px, rgba(0,0,0,.1) 0 20px 20px;
    }

    paper-spinner {
      font-size: 0px;
    }

    paper-dialog {
      width: calc(100% - 20px);
      max-width: 600px;
      height: auto;
      word-wrap: break-word;
    }

    #copy {
      cursor: copy;
    }

    .ok-icon{
      --iron-icon-height: var(--icon-size);
      --iron-icon-width: var(--icon-size);
      --iron-icon-fill-color: rgb(0, 191, 255);
    }

    .nok-icon{
      --iron-icon-height: var(--icon-size);
      --iron-icon-width: var(--icon-size);
      --iron-icon-fill-color: rgb(255,0,0);
    }
    
  </style>

  <div class="wrapper">

    <div class="title">
      <template is="dom-if" if=[[loading]]>
        <paper-spinner active></paper-spinner>
      </template>

      <template is="dom-if" if=[[!loading]]>
        <template is="dom-if" if=[[!playerError.status]]>
          <iron-icon class="ok-icon" icon="icons:check-circle"></iron-icon>
        </template>
      </template>

      <template is="dom-if" if=[[playerError.status]]>
        <iron-icon class="nok-icon" icon="icons:cancel"></iron-icon>
      </template>
      <h1>
        {{toUpper(playerName)}} WINS:
      </h1>
    </div>
  
    <template is="dom-if" if=[[!playerError.status]]>
      <div class="count">

        <template is="dom-if" if=[[!loadingRank]]>
          <h3>[[wins]]</h3>
        </template>

        <template is="dom-if" if=[[loadingRank]]>
          <paper-spinner active></paper-spinner>
        </template>

      </div>
    </template>



    <template is="dom-if" if=[[playerError.status]]>
      <div class="error">
        <template is="dom-if" if=[[!loadingRank]]>
          <div>[[playerError.message]]</div>
        </template>

        <template is="dom-if" if=[[loadingRank]]>
          <paper-spinner active></paper-spinner>
        </template>
      </div>
    </template>

  </div>
</template>

<script>

  class WinCounter extends Polymer.Element {
    static get is() { return 'win-counter'; }
    static get properties() {
      return {
        res: {
          type: String
        },

        loading: {
          type: Boolean,
          value: true
        },
        loadingRank: {
          type: Boolean,
          value: true
        },
        oldMatchId: {
          type: String,
          value: ""
        },
        wins: {
          type: Number,
          value: 0
        },
        initialized: {
          type: Boolean,
          value: false,
        },

        playerError: {
          type: Object,
          value: () => {
            return {
              "status": false,
              "message": "",
            }
          }
        }

      };
    }

    toUpper(name) {
      return name.toUpperCase();
    }

    ready() {
      super.ready();

      this.getData();

      setInterval(() => {
        this.getData();
      }, 20000);
      
    };

    getData(){
      const headers = {
        headers: {
          'Authorization': `Bearer ${this.apiKey}`,
          'Accept': 'application/vnd.api+json',
          'Content-Type': 'application/json'
        } 
      }

      axios.get(`https://api.playbattlegrounds.com/shards/${this.region}/players?filter[playerNames]=${this.playerName}`, headers).then( (res) => { 
        // console.log(res);
        // console.log("getting player");
        console.log(res.data);
        let newestMatchId = res.data.data[0].relationships.matches.data[0].id;
        this.set('playerError.status', false);
        console.log(res.data.data[0].relationships.matches);
        console.log(newestMatchId);
        console.log(this.oldMatchId);

        if(newestMatchId !== this.oldMatchId){
          console.log("NEW MATCH:");
          this.res = res.data.data[0].attributes.name + " " + res.data.data[0].id;
          this.loading = false;

          axios.get(`https://api.playbattlegrounds.com/shards/${this.region}/matches/${newestMatchId}`, headers).then( (res) => {
            let player = res.data.included.filter( (item) => {
              return item.type === 'participant' && item.attributes.stats.name === this.playerName;
            })[0];

            let lastRank = player.attributes.stats.winPlace;

            if(this.initialized){
              if(lastRank === 1){
                console.log("Win!");
                this.wins += 1;                  
              }
            } 

            console.log("No win :(");
            this.loadingRank = false;

            if(!this.initialized){
              this.initialized = true;
            }

            // this.$.modal.open();
            // setTimeout(()=>{
            //   this.$.modal.close();
            // }, 5000);
            console.log("");
            // console.log("Success");
            this.oldMatchId = newestMatchId;
          });
        } else {
          // console.log('no new match');
        }
      }).catch((err) => {
        // console.log(err.response);
        // console.log(err.response.status);

        this.set('playerError.status', true);

        if(err.response.status === 401){
          this.set('playerError.message', 'Invalid API key!');
        } else if (err.response.status === 429){
          this.set('playerError.message', 'Too many requests!');
        } else {
          this.set('playerError.message', err.response.data.errors[0].detail);
        }

        this.loading = false;
        this.loadingRank = false;
      });
    
    }

  }

  window.customElements.define(WinCounter.is, WinCounter);
</script>
</dom-module>
